{"version":3,"file":"entry.server.js","sources":["../../../node_modules/zudoku/src/lib/core/plugins.ts","../../../node_modules/zudoku/src/app/main.tsx","../../../node_modules/zudoku/src/app/entry.server.tsx"],"sourcesContent":["import type { LucideIcon } from \"lucide-react\";\nimport { type ReactElement } from \"react\";\nimport { type RouteObject } from \"react-router\";\nimport type { Sidebar } from \"../../config/validators/SidebarSchema.js\";\nimport { MdxComponentsType } from \"../util/MdxComponents.js\";\nimport { ZudokuContext, type ApiIdentity } from \"./ZudokuContext.js\";\n\nexport type ZudokuPlugin =\n  | CommonPlugin\n  | ProfileMenuPlugin\n  | NavigationPlugin\n  | ApiIdentityPlugin\n  | SearchProviderPlugin;\n\nexport type { RouteObject };\n\nexport interface NavigationPlugin {\n  getRoutes: () => RouteObject[];\n  getSidebar?: (path: string) => Promise<Sidebar>;\n}\n\nexport interface ApiIdentityPlugin {\n  getIdentities: (context: ZudokuContext) => Promise<ApiIdentity[]>;\n}\n\nexport interface SearchProviderPlugin {\n  renderSearch: (o: {\n    isOpen: boolean;\n    onClose: () => void;\n  }) => React.JSX.Element | null;\n}\n\nexport interface ProfileMenuPlugin {\n  getProfileMenuItems: (context: ZudokuContext) => ProfileNavigationItem[];\n}\n\nexport type ProfileNavigationItem = {\n  label: string;\n  path?: string;\n  weight?: number;\n  category?: \"top\" | \"middle\" | \"bottom\";\n  children?: ProfileNavigationItem[];\n  icon?: LucideIcon;\n};\n\nexport interface CommonPlugin {\n  initialize?: (\n    context: ZudokuContext,\n  ) => Promise<void | boolean> | void | boolean;\n  getHead?: () => ReactElement | undefined;\n  getMdxComponents?: () => MdxComponentsType;\n}\n\nexport const isProfileMenuPlugin = (\n  obj: ZudokuPlugin,\n): obj is ProfileMenuPlugin =>\n  \"getProfileMenuItems\" in obj && typeof obj.getProfileMenuItems === \"function\";\n\nexport const isNavigationPlugin = (\n  obj: ZudokuPlugin,\n): obj is NavigationPlugin =>\n  \"getRoutes\" in obj && typeof obj.getRoutes === \"function\";\n\nexport const isSearchPlugin = (\n  obj: ZudokuPlugin,\n): obj is SearchProviderPlugin =>\n  \"renderSearch\" in obj && typeof obj.renderSearch === \"function\";\n\nexport const needsInitialization = (obj: ZudokuPlugin): obj is CommonPlugin =>\n  \"initialize\" in obj && typeof obj.initialize === \"function\";\n\nexport const hasHead = (obj: ZudokuPlugin): obj is CommonPlugin =>\n  \"getHead\" in obj && typeof obj.getHead === \"function\";\n\nexport const isMdxProviderPlugin = (obj: ZudokuPlugin): obj is CommonPlugin =>\n  \"getMdxComponents\" in obj && typeof obj.getMdxComponents === \"function\";\n\nexport const isApiIdentityPlugin = (\n  obj: ZudokuPlugin,\n): obj is ApiIdentityPlugin =>\n  \"getIdentities\" in obj && typeof obj.getIdentities === \"function\";\n","import { type RouteObject } from \"react-router\";\nimport { configuredApiKeysPlugin } from \"virtual:zudoku-api-keys-plugin\";\nimport {\n  configuredApiCatalogPlugins,\n  configuredApiPlugins,\n} from \"virtual:zudoku-api-plugins\";\nimport { configuredAuthProvider } from \"virtual:zudoku-auth\";\nimport { configuredCustomPagesPlugin } from \"virtual:zudoku-custom-pages-plugin\";\nimport { configuredDocsPlugins } from \"virtual:zudoku-docs-plugins\";\nimport { configuredRedirectPlugin } from \"virtual:zudoku-redirect-plugin\";\nimport { configuredSearchPlugin } from \"virtual:zudoku-search-plugin\";\nimport { configuredSidebar } from \"virtual:zudoku-sidebar\";\nimport \"virtual:zudoku-theme.css\";\nimport { Layout, RouterError, Zudoku } from \"zudoku/components\";\nimport type { ZudokuConfig } from \"../config/config.js\";\nimport type { ZudokuContextOptions } from \"../lib/core/ZudokuContext.js\";\nimport { isNavigationPlugin } from \"../lib/core/plugins.js\";\n\nexport const convertZudokuConfigToOptions = (\n  config: ZudokuConfig,\n): ZudokuContextOptions => {\n  const fallbackLogoLight =\n    config.page?.logoUrl ??\n    \"https://cdn.zudoku.dev/logos/zudoku-logo-full-light.svg\";\n  const fallbackLogoDark =\n    config.page?.logoUrl ??\n    \"https://cdn.zudoku.dev/logos/zudoku-logo-full-dark.svg\";\n\n  const isUsingFallback =\n    !config.page?.logoUrl &&\n    !config.page?.logo?.src?.light &&\n    !config.page?.logo?.src?.dark;\n\n  return {\n    page: {\n      ...config.page,\n      logo: {\n        ...(isUsingFallback ? { width: \"130px\" } : {}),\n        ...config.page?.logo,\n        src: {\n          light: config.page?.logo?.src?.light ?? fallbackLogoLight,\n          dark: config.page?.logo?.src?.dark ?? fallbackLogoDark,\n        },\n      },\n    },\n    slotlets: config.UNSAFE_slotlets,\n    metadata: {\n      favicon: \"https://cdn.zudoku.dev/logos/favicon.svg\",\n      title: \"%s - Zudoku\",\n      ...config.metadata,\n    },\n    sidebars: configuredSidebar,\n    topNavigation: config.topNavigation,\n    mdx: config.mdx,\n    authentication: configuredAuthProvider,\n    plugins: [\n      ...configuredDocsPlugins,\n      ...configuredApiPlugins,\n      ...(configuredSearchPlugin ? [configuredSearchPlugin] : []),\n      ...(configuredRedirectPlugin ? [configuredRedirectPlugin] : []),\n      ...(configuredApiKeysPlugin ? [configuredApiKeysPlugin] : []),\n      ...(configuredCustomPagesPlugin ? [configuredCustomPagesPlugin] : []),\n      ...configuredApiCatalogPlugins,\n      ...(configuredAuthProvider?.getAuthenticationPlugin\n        ? [configuredAuthProvider.getAuthenticationPlugin()]\n        : []),\n      ...(config.plugins ?? []),\n    ],\n  };\n};\n\nexport const getRoutesByOptions = (options: ZudokuContextOptions) => {\n  const allPlugins = [\n    ...(options.plugins ? options.plugins : []),\n    ...(options.authentication?.getAuthenticationPlugin\n      ? [options.authentication.getAuthenticationPlugin()]\n      : []),\n  ];\n\n  const routes = allPlugins\n    .flatMap((plugin) => (isNavigationPlugin(plugin) ? plugin.getRoutes() : []))\n    .concat({\n      path: \"*\",\n      loader: () => {\n        throw new Response(\"Not Found\", { status: 404 });\n      },\n    });\n\n  return routes;\n};\n\nexport const getRoutesByConfig = (config: ZudokuConfig): RouteObject[] => {\n  const options = convertZudokuConfigToOptions(config);\n  const routes = getRoutesByOptions(options);\n\n  return [\n    {\n      element: (\n        <Zudoku {...options}>\n          <Layout />\n        </Zudoku>\n      ),\n      children: [\n        {\n          errorElement: <RouterError />,\n          children: routes,\n        },\n      ],\n    },\n  ];\n};\n","import { dehydrate, QueryClient } from \"@tanstack/react-query\";\nimport { type HelmetData } from \"@zudoku/react-helmet-async\";\nimport type express from \"express\";\nimport logger from \"loglevel\";\nimport { Transform } from \"node:stream\";\nimport { renderToPipeableStream, renderToStaticMarkup } from \"react-dom/server\";\nimport {\n  createStaticHandler,\n  createStaticRouter,\n  isRouteErrorResponse,\n} from \"react-router\";\nimport \"virtual:zudoku-theme.css\";\nimport \"vite/modulepreload-polyfill\";\nimport { BootstrapStatic, ServerError } from \"zudoku/components\";\nimport type { ZudokuConfig } from \"../config/config.js\";\nimport type { FileWritingResponse } from \"../vite/prerender.js\";\nimport \"./main.css\";\nimport { getRoutesByConfig } from \"./main.js\";\n\nexport { getRoutesByConfig };\n\nexport const render = async ({\n  template,\n  request: baseRequest,\n  response,\n  config,\n}: {\n  template: string;\n  request: express.Request | Request;\n  response: express.Response | FileWritingResponse;\n  config: ZudokuConfig;\n}) => {\n  const routes = getRoutesByConfig(config);\n  const { query, dataRoutes } = createStaticHandler(routes, {\n    basename: config.basePath,\n  });\n  const queryClient = new QueryClient();\n\n  const request =\n    baseRequest instanceof Request\n      ? baseRequest\n      : createFetchRequest(baseRequest, response);\n\n  const context = await query(request);\n  let status = 200;\n\n  if (context instanceof Response) {\n    if ([301, 302, 303, 307, 308].includes(context.status)) {\n      return response.redirect(\n        context.status,\n        context.headers.get(\"Location\")!,\n      );\n    }\n\n    throw context;\n  } else if (context.errors) {\n    // when throwing a Response from a loader it will be caught here\n    // unfortunately it is not `instanceof Response` for some reason\n    const firstError = Object.values(context.errors).find(isRouteErrorResponse);\n\n    if (firstError?.status) {\n      status = firstError.status;\n    }\n  }\n\n  const router = createStaticRouter(dataRoutes, context);\n  const helmetContext = {} as HelmetData[\"context\"];\n\n  const App = (\n    <BootstrapStatic\n      router={router}\n      context={context}\n      queryClient={queryClient}\n      helmetContext={helmetContext}\n    />\n  );\n\n  const { pipe } = renderToPipeableStream(App, {\n    onShellError(error) {\n      response.status(500);\n      response.set({ \"Content-Type\": \"text/html\" });\n\n      const html = renderToStaticMarkup(<ServerError error={error} />);\n\n      response.send(html);\n    },\n    // for SSG we could use onAllReady instead of onShellReady\n    // https://react.dev/reference/react-dom/server/renderToPipeableStream#waiting-for-all-content-to-load-for-crawlers-and-static-generation\n    onAllReady() {\n      response.set({ \"Content-Type\": \"text/html\" });\n      response.status(status);\n\n      const transformStream = new Transform({\n        transform(chunk, encoding, callback) {\n          response.write(chunk, encoding);\n          callback();\n        },\n      });\n\n      const [htmlStart, htmlEnd] = template.split(\"<!--app-html-->\");\n\n      if (!htmlStart) {\n        throw new Error(\"No <!--app-html--> found in template\");\n      }\n\n      response.write(\n        htmlStart.replace(\n          \"<!--app-helmet-->\",\n          [\n            helmetContext.helmet.title.toString(),\n            helmetContext.helmet.meta.toString(),\n            helmetContext.helmet.link.toString(),\n            helmetContext.helmet.style.toString(),\n            helmetContext.helmet.script.toString(),\n          ].join(\"\\n\"),\n        ),\n      );\n\n      transformStream.on(\"finish\", () => {\n        response.end(\n          htmlEnd?.replace(\n            \"</body>\",\n            `<script>window.DATA = ${JSON.stringify(dehydrate(queryClient))}</script></body>`,\n          ),\n        );\n      });\n\n      pipe(transformStream);\n    },\n    onError(error) {\n      status = 500;\n      logger.error(error);\n    },\n  });\n};\n\nexport function createFetchRequest(\n  req: express.Request,\n  res: express.Response | FileWritingResponse,\n): Request {\n  const origin = `${req.protocol}://${req.get(\"host\")}`;\n  // Note: This had to take originalUrl into account for presumably vite's proxying\n  const url = new URL(req.originalUrl || req.url, origin);\n\n  const controller = new AbortController();\n  res.on(\"close\", () => controller.abort());\n\n  const headers = new Headers();\n\n  for (const [key, values] of Object.entries(req.headers)) {\n    if (values) {\n      if (Array.isArray(values)) {\n        for (const value of values) {\n          headers.append(key, value);\n        }\n      } else {\n        headers.set(key, values);\n      }\n    }\n  }\n\n  const init: RequestInit = {\n    method: req.method,\n    headers,\n    signal: controller.signal,\n  };\n\n  if (req.method !== \"GET\" && req.method !== \"HEAD\") {\n    init.body = req.body;\n  }\n\n  return new Request(url.href, init);\n}\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AA0DO,MAAM,qBAAqB,CAChC,QAEA,eAAe,OAAO,OAAO,IAAI,cAAc;AC3CpC,MAAA,+BAA+B,CAC1C,WACyB;;AACnB,QAAA,sBACJ,YAAO,SAAP,mBAAa,YACb;AACI,QAAA,qBACJ,YAAO,SAAP,mBAAa,YACb;AAEF,QAAM,kBACJ,GAAC,YAAO,SAAP,mBAAa,YACd,GAAC,wBAAO,SAAP,mBAAa,SAAb,mBAAmB,QAAnB,mBAAwB,UACzB,GAAC,wBAAO,SAAP,mBAAa,SAAb,mBAAmB,QAAnB,mBAAwB;AAEpB,SAAA;AAAA,IACL,MAAM;AAAA,MACJ,GAAG,OAAO;AAAA,MACV,MAAM;AAAA,QACJ,GAAI,kBAAkB,EAAE,OAAO,YAAY,CAAC;AAAA,QAC5C,IAAG,YAAO,SAAP,mBAAa;AAAA,QAChB,KAAK;AAAA,UACH,SAAO,wBAAO,SAAP,mBAAa,SAAb,mBAAmB,QAAnB,mBAAwB,UAAS;AAAA,UACxC,QAAM,wBAAO,SAAP,mBAAa,SAAb,mBAAmB,QAAnB,mBAAwB,SAAQ;AAAA,QAAA;AAAA,MACxC;AAAA,IAEJ;AAAA,IACA,UAAU,OAAO;AAAA,IACjB,UAAU;AAAA,MACR,SAAS;AAAA,MACT,OAAO;AAAA,MACP,GAAG,OAAO;AAAA,IACZ;AAAA,IACA,UAAU;AAAA,IACV,eAAe,OAAO;AAAA,IACtB,KAAK,OAAO;AAAA,IACZ,gBAAgB;AAAA,IAChB,SAAS;AAAA,MACP,GAAG;AAAA,MACH,GAAG;AAAA,MACH,GAAwD,CAAC;AAAA,MACzD,GAAI,2BAA2B,CAAC,wBAAwB,IAAI,CAAC;AAAA,MAC7D,GAA0D,CAAC;AAAA,MAC3D,GAAkE,CAAC;AAAA,MACnE,GAAG;AAAA,MACH,GAEI,CAAC;AAAA,MACL,GAAI,OAAO,WAAW,CAAA;AAAA,IAAC;AAAA,EAE3B;AACF;AAEa,MAAA,qBAAqB,CAAC,YAAkC;AACnE,QAAM,aAAa;AAAA,IACjB,GAAI,QAAQ,UAAU,QAAQ,UAAU,CAAC;AAAA,IACzC,GAEI,CAAA;AAAA,EACN;AAEA,QAAM,SAAS,WACZ,QAAQ,CAAC,WAAY,mBAAmB,MAAM,IAAI,OAAO,UAAU,IAAI,CAAG,CAAA,EAC1E,OAAO;AAAA,IACN,MAAM;AAAA,IACN,QAAQ,MAAM;AACZ,YAAM,IAAI,SAAS,aAAa,EAAE,QAAQ,KAAK;AAAA,IAAA;AAAA,EACjD,CACD;AAEI,SAAA;AACT;AAEa,MAAA,oBAAoB,CAAC,WAAwC;AAClE,QAAA,UAAU,6BAA6B,MAAM;AAC7C,QAAA,SAAS,mBAAmB,OAAO;AAElC,SAAA;AAAA,IACL;AAAA,MACE,SACG,oBAAA,QAAA,EAAQ,GAAG,SACV,UAAA,oBAAC,SAAO,CAAA,GACV;AAAA,MAEF,UAAU;AAAA,QACR;AAAA,UACE,kCAAe,aAAY,EAAA;AAAA,UAC3B,UAAU;AAAA,QAAA;AAAA,MACZ;AAAA,IACF;AAAA,EAEJ;AACF;ACzFO,MAAM,SAAS,OAAO;AAAA,EAC3B;AAAA,EACA,SAAS;AAAA,EACT;AAAA,EACA;AACF,MAKM;AACE,QAAA,SAAS,kBAAkB,MAAM;AACvC,QAAM,EAAE,OAAO,eAAe,oBAAoB,QAAQ;AAAA,IACxD,UAAU,OAAO;AAAA,EAAA,CAClB;AACK,QAAA,cAAc,IAAI,YAAY;AAEpC,QAAM,UACJ,uBAAuB,UACnB,cACA,mBAAmB,aAAa,QAAQ;AAExC,QAAA,UAAU,MAAM,MAAM,OAAO;AACnC,MAAI,SAAS;AAEb,MAAI,mBAAmB,UAAU;AAC3B,QAAA,CAAC,KAAK,KAAK,KAAK,KAAK,GAAG,EAAE,SAAS,QAAQ,MAAM,GAAG;AACtD,aAAO,SAAS;AAAA,QACd,QAAQ;AAAA,QACR,QAAQ,QAAQ,IAAI,UAAU;AAAA,MAChC;AAAA,IAAA;AAGI,UAAA;AAAA,EAAA,WACG,QAAQ,QAAQ;AAGzB,UAAM,aAAa,OAAO,OAAO,QAAQ,MAAM,EAAE,KAAK,oBAAoB;AAE1E,QAAI,yCAAY,QAAQ;AACtB,eAAS,WAAW;AAAA,IAAA;AAAA,EACtB;AAGI,QAAA,SAAS,mBAAmB,YAAY,OAAO;AACrD,QAAM,gBAAgB,CAAC;AAEvB,QAAM,MACJ;AAAA,IAAC;AAAA,IAAA;AAAA,MACC;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,IAAA;AAAA,EACF;AAGF,QAAM,EAAE,KAAA,IAAS,uBAAuB,KAAK;AAAA,IAC3C,aAAa,OAAO;AAClB,eAAS,OAAO,GAAG;AACnB,eAAS,IAAI,EAAE,gBAAgB,YAAA,CAAa;AAE5C,YAAM,OAAO,qBAAsB,oBAAA,aAAA,EAAY,OAAc,CAAE;AAE/D,eAAS,KAAK,IAAI;AAAA,IACpB;AAAA;AAAA;AAAA,IAGA,aAAa;AACX,eAAS,IAAI,EAAE,gBAAgB,YAAA,CAAa;AAC5C,eAAS,OAAO,MAAM;AAEhB,YAAA,kBAAkB,IAAI,UAAU;AAAA,QACpC,UAAU,OAAO,UAAU,UAAU;AAC1B,mBAAA,MAAM,OAAO,QAAQ;AACrB,mBAAA;AAAA,QAAA;AAAA,MACX,CACD;AAED,YAAM,CAAC,WAAW,OAAO,IAAI,SAAS,MAAM,iBAAiB;AAE7D,UAAI,CAAC,WAAW;AACR,cAAA,IAAI,MAAM,sCAAsC;AAAA,MAAA;AAG/C,eAAA;AAAA,QACP,UAAU;AAAA,UACR;AAAA,UACA;AAAA,YACE,cAAc,OAAO,MAAM,SAAS;AAAA,YACpC,cAAc,OAAO,KAAK,SAAS;AAAA,YACnC,cAAc,OAAO,KAAK,SAAS;AAAA,YACnC,cAAc,OAAO,MAAM,SAAS;AAAA,YACpC,cAAc,OAAO,OAAO,SAAS;AAAA,UACvC,EAAE,KAAK,IAAI;AAAA,QAAA;AAAA,MAEf;AAEgB,sBAAA,GAAG,UAAU,MAAM;AACxB,iBAAA;AAAA,UACP,mCAAS;AAAA,YACP;AAAA,YACA,yBAAyB,KAAK,UAAU,UAAU,WAAW,CAAC,CAAC;AAAA;AAAA,QAEnE;AAAA,MAAA,CACD;AAED,WAAK,eAAe;AAAA,IACtB;AAAA,IACA,QAAQ,OAAO;AACJ,eAAA;AACT,aAAO,MAAM,KAAK;AAAA,IAAA;AAAA,EACpB,CACD;AACH;AAEgB,SAAA,mBACd,KACA,KACS;AACH,QAAA,SAAS,GAAG,IAAI,QAAQ,MAAM,IAAI,IAAI,MAAM,CAAC;AAEnD,QAAM,MAAM,IAAI,IAAI,IAAI,eAAe,IAAI,KAAK,MAAM;AAEhD,QAAA,aAAa,IAAI,gBAAgB;AACvC,MAAI,GAAG,SAAS,MAAM,WAAW,OAAO;AAElC,QAAA,UAAU,IAAI,QAAQ;AAEjB,aAAA,CAAC,KAAK,MAAM,KAAK,OAAO,QAAQ,IAAI,OAAO,GAAG;AACvD,QAAI,QAAQ;AACN,UAAA,MAAM,QAAQ,MAAM,GAAG;AACzB,mBAAW,SAAS,QAAQ;AAClB,kBAAA,OAAO,KAAK,KAAK;AAAA,QAAA;AAAA,MAC3B,OACK;AACG,gBAAA,IAAI,KAAK,MAAM;AAAA,MAAA;AAAA,IACzB;AAAA,EACF;AAGF,QAAM,OAAoB;AAAA,IACxB,QAAQ,IAAI;AAAA,IACZ;AAAA,IACA,QAAQ,WAAW;AAAA,EACrB;AAEA,MAAI,IAAI,WAAW,SAAS,IAAI,WAAW,QAAQ;AACjD,SAAK,OAAO,IAAI;AAAA,EAAA;AAGlB,SAAO,IAAI,QAAQ,IAAI,MAAM,IAAI;AACnC;","x_google_ignoreList":[0,1,2]}